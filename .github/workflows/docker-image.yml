# docker-image.yml
name: Build and Push Docker Image

on:
  push:
    branches:
      - "main"
    tags:
      - "docker"
  workflow_dispatch:

jobs:
  build-tencent:
    runs-on: [self-hosted, docker]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 生成时间戳 tag (格式: YYYYMMDDHHMM)
      - name: Generate Timestamp Tag
        run: echo "IMAGE_TAG=$(date +'%Y%m%d%H%M')" >> $GITHUB_ENV

      # 构建 Docker 镜像
      - name: Build Docker Image
        run: |
          docker build -t media-downloader:${{ env.IMAGE_TAG }} .
          docker tag media-downloader:${{ env.IMAGE_TAG }} ccr.ccs.tencentyun.com/chaoship/media-downloader:${{ env.IMAGE_TAG }}
          docker tag media-downloader:${{ env.IMAGE_TAG }} ccr.ccs.tencentyun.com/chaoship/media-downloader:latest

      # 推送镜像到腾讯云
      - name: Push to Tencent Cloud Registry
        run: |
          docker push ccr.ccs.tencentyun.com/chaoship/media-downloader:${{ env.IMAGE_TAG }}
          docker push ccr.ccs.tencentyun.com/chaoship/media-downloader:latest

      # 清理本地镜像
      - name: Cleanup Local Images
        run: |
          docker rmi media-downloader:${{ env.IMAGE_TAG }} || true
          docker rmi ccr.ccs.tencentyun.com/chaoship/media-downloader:${{ env.IMAGE_TAG }} || true
          docker rmi ccr.ccs.tencentyun.com/chaoship/media-downloader:latest || true
